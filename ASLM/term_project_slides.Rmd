---
title: "Term_project_ppt"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, message=FALSE}
library(corrplot)
library(tidyverse)
```


# Data Introduction

## 資料來源: 
[Concrete Compressive Strength Data Set, UCI Machine Learning Repository](http://archive.ics.uci.edu/ml/datasets/concrete+compressive+strength) 


## 變數介紹

- 8 項與混凝土抗壓強度有關的解釋變數($X_i$):

    1. Cement: 水泥
    2. Blast Furnace Slag: 高爐渣, 簡稱 BFS →高爐煉鐵過程中排出的渣
    3. Fly Ash: 飛灰, 簡稱 FlyAsh →發電廠燒煤時的廢棄物
    4. Water: 水
    5. Superplasticizer: 塑化劑, 簡稱 SP →增加材料的柔軟性或使材料液化的添加劑
    6. Coarse Aggregate: 粗骨材, 簡稱 CA →一般為天然石或者為人造石
    7. Fine Aggregate: 细骨料, 簡稱 FA →一般為天然砂或者人造砂
    8. Age: 製造天數

- 被解釋變數($Y$):

    1. Concrete compressive strength: 混凝土抗壓強度, 簡稱 CCS
  
- 共1030筆觀察值

## 研究問題

我們想了解哪些因素和混凝土抗壓強度有關。

# Data Visualization I
```{r, echo=FALSE}
# load("C:/Users/s3372/Downloads/training_prediction_sample.rdata")
load("D:/10702/ASLM/training_prediction_sample.rdata")
load("D:/10702/ASLM/training_prediction_index.rdata")

names(r.model) <- c('Cement', 'BFS', 'FlyAsh', 'Water', 'SP', 'CA', 'FA', 'Age', 'CCS')
names(r.pred) <- c('Cement', 'BFS', 'FlyAsh', 'Water', 'SP', 'CA', 'FA', 'Age', 'CCS')
```

首先我們畫出所有變數的 density plot。
```{r, echo=FALSE, fig.align='center', fig.height=8, fig.width=8}
r.model %>% na.omit() %>%
  gather(type,value,1:9) %>%
  ggplot(aes(x = value)) + 
  geom_density(alpha = 1) + 
  facet_wrap(~ type, scales="free") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 1), plot.title = element_text(hjust = 0.5)) + 
  labs(title="Density Plots of Data") +
  ylab("")
```


# Data Visualization II
接著我們畫出所有變數的 correlation coefficient plot。
```{r, fig.align='center', fig.height=6, fig.width=8}
M <- cor(r.model[,c(1:9)])
corrplot.mixed(M, upper = "pie")
```


# Split data

我們將 1030 筆資料切分成 515 筆 train data 以及 515 筆 test data，並利用 train data 進行模型挑選。



# Model Selection I

## Stepwise function

我們的 Stepwise 方向為 both ，挑選的 criterion 為 AIC， 此階段挑選出兩個可行模型。

 1. $CCS = Cement + BFS + FlyAsh + Water + SP + Age + \epsilon$
 2. $CCS = Cement + BFS + FlyAsh + Water + Age + \epsilon$
 
```{r}
fit1=lm(CCS~Cement+BFS+FlyAsh+Water+SP+CA+FA+Age,data=r.model)
step(fit1)

fit2=lm(CCS~Cement+BFS+FlyAsh+Water+SP+CA+Age,data=r.model)
step(fit2)

fit3=lm(CCS~Cement+BFS+FlyAsh+Water+SP+Age,data=r.model)
step(fit3)
```


# Model Selection II

```{r}
#p=7
z=lm(CCS~Cement+BFS+FlyAsh+Water+SP+Age,data=r.model)
summary(z)
m.coef=z$coefficients
p.Y=m.coef[1]+m.coef[2]*r.pred[,1]+m.coef[3]*r.pred[,2]+m.coef[4]*r.pred[,3]+m.coef[5]*r.pred[,4]+m.coef[6]*r.pred[,8]

sum((r.pred$CCS-p.Y)^2/length(p.Y)) #MSPR
anova(z) 
```

此模型SSE=107, MSPR=223, 差距有點大。


```{r}
#p=6
z=lm(CCS~Cement+BFS+FlyAsh+Water+Age,data=r.model)
summary(z)
m.coef=z$coefficients
p.Y=m.coef[1]+m.coef[2]*r.pred[,1]+m.coef[3]*r.pred[,2]+m.coef[4]*r.pred[,3]+m.coef[5]*r.pred[,4]+m.coef[6]*r.pred[,8]

sum((r.pred$CCS-p.Y)^2/length(p.Y)) #MSPR
anova(z)
```

此模型SSE=108, MSPR=111, 非常接近，所以我們的模型挑選了五個變量。

# Model Selection III

- $m_0: CCS = Cement + BFS + FlyAsh + Water + Age + \epsilon$

我們原始的模型為$m_0$，首先 fit $m_0$ 後畫出殘差圖:

```{r, fig.height=6, fig.width=9, echo=FALSE}
m0=lm(CCS~Cement+BFS+FlyAsh+Water+Age,data=r.model)
par(mfrow=c(2,3))
plot(m0$fitted.values, m0$residuals, xlab="Fitted value", ylab="Residuals")
abline(0,0,col="red")
plot(r.model$Cement, m0$residuals, xlab="Cement", ylab="Residuals")
abline(0,0,col="red")
plot(r.model$BFS, m0$residuals, xlab="BFS", ylab="Residuals")
abline(0,0,col="red")
plot(r.model$FlyAsh, m0$residuals, xlab="FlyAsh", ylab="Residuals")
abline(0,0,col="red")
plot(r.model$Water, m0$residuals, xlab="Water", ylab="Residuals")
abline(0,0,col="red")
plot(r.model$Age, m0$residuals, xlab="Age", ylab="Residuals")
abline(0,0,col="red")
```

從上面的殘差圖，可以看出兩項問題: 

 1. 由$\widehat{y_{m_0}}$ 對殘差的scatter plot可以看出變異數可能不同值的現象。
 2. 由$Age$ 對殘差的scatter plot可以看出製造天數可能和CCS可能有非線性關係。

我們針對問題 1 進行 Breusch-Pagan test，發現變異數的確不同值，由 BoxCox test 可知 likelihood 最低應為$\lambda=0.7$，於是我們令$Y^{\lambda=0.5}=\sqrt{Y}$ 放進新模型$m_1$

- $m_1: \sqrt{CCS} = Cement + BFS + FlyAsh + Water + Age + \epsilon$


```{r}
data1=cbind(r.model[,1:4],r.model[[8]],r.model$CCS^0.5)
names(data1)<-c('Cement', 'BFS', 'FlyAsh', 'Water', 'Age', 'sqrt.CCS')
m1=lm(sqrt.CCS~.,data=data1)
summary(m1)
```


```{r, fig.height=6, fig.width=9, echo=FALSE}
par(mfrow=c(2,3))
plot(m1$fitted.values,m1$residuals,xlab="Fitted value",ylab="Residuals")
abline(0,0,col="red")
plot(data1$Cement,m1$residuals,xlab="Cement",ylab="Residuals")
abline(0,0,col="red")
plot(data1$BFS,m1$residuals,xlab="BFS",ylab="Residuals")
abline(0,0,col="red")
plot(data1$FlyAsh,m1$residuals,xlab="FlyAsh",ylab="Residuals")
abline(0,0,col="red")
plot(data1$Water,m1$residuals,xlab="Water",ylab="Residuals")
abline(0,0,col="red")
plot(data1$Age,m1$residuals,xlab="Age",ylab="Residuals")
abline(0,0,col="red")
```

接著我們針對問題 2，在模型中加入$Age^2$，不過無助於解決Age對於CCS的非線性問題，可由下面的殘差圖得知。

- $m_2: \sqrt{CCS} = Cement + BFS + FlyAsh + Water + Age + Age^2 + \epsilon$

```{r}
data1s=cbind(r.model[,1:4],r.model[[8]],r.model[[8]]^2,r.model$CCS^0.5)
data1s.c=apply(data1s[-7],2,function(x){ x-mean(x)})
data1s.c=as.data.frame(cbind(data1s.c,r.model$CCS^0.5))
names(data1s.c)=c('Cement', 'BFS', 'FlyAsh', 'Water', 'Age','Age^2', 'sqrt.CCS')
m2=lm(sqrt.CCS~.,data=data1s.c)
summary(m2)
```

```{r, fig.height=6, fig.width=9, echo=FALSE}
par(mfrow=c(2,4))
plot(m2$fitted.values,m2$residuals,xlab="Fitted value",ylab="Residuals")
abline(0,0,col="red")
plot(data1s.c$Cement,m2$residuals,xlab="Cement",ylab="Residuals")
abline(0,0,col="red")
plot(data1s.c$BFS,m2$residuals,xlab="BFS",ylab="Residuals")
abline(0,0,col="red")
plot(data1s.c$FlyAsh,m2$residuals,xlab="FlyAsh",ylab="Residuals")
abline(0,0,col="red")
plot(data1s.c$Water,m2$residuals,xlab="Water",ylab="Residuals")
abline(0,0,col="red")
plot(data1s.c$Age,m2$residuals,xlab="Age",ylab="Residuals")
abline(0,0,col="red")
plot(data1s.c$Age^2,m2$residuals,xlab="Age^2",ylab="Residuals")
abline(0,0,col="red")
```


最後，我們加入$\sqrt{Age}$，得到模型$m_3$ 

- $m_3: \sqrt{CCS} = Cement + BFS + FlyAsh + Water + Age + \sqrt{Age} + \epsilon$ 

由於加入$\sqrt(Age)$，我們把模型中的變量做centering處理。
```{r}
data2=cbind(r.model[,1:4],r.model[[8]],r.model[[8]]^0.5,r.model$CCS^0.5)
data2.c=apply(data2[-7],2,function(x){ x-mean(x)})
data2.c=as.data.frame(cbind(data2.c,r.model$CCS^0.5))
names(data2.c)=c('Cement', 'BFS', 'FlyAsh', 'Water', 'Age','sqrt.Age', 'CCS')
m3=lm(CCS~Cement+BFS+FlyAsh+Water+Age+sqrt.Age,data=data2.c)
summary(m3)
```

```{r,fig.height=6, fig.width=9, echo=FALSE}
par(mfrow=c(2,4))
plot(m3$fitted.values,m3$residuals,xlab="Fitted value",ylab="Residuals")
abline(0,0,col="red")
plot(data2.c$Cement,m3$residuals,xlab="Cement",ylab="Residuals")
abline(0,0,col="red")
plot(data2.c$BFS,m3$residuals,xlab="BFS",ylab="Residuals")
abline(0,0,col="red")
plot(data2.c$FlyAsh,m3$residuals,xlab="FlyAsh",ylab="Residuals")
abline(0,0,col="red")
plot(data2.c$Water,m3$residuals,xlab="Water",ylab="Residuals")
abline(0,0,col="red")
plot(data2.c$Age,m3$residuals,xlab="Age",ylab="Residuals")
abline(0,0,col="red")
plot(data2.c$sqrt.Age,m3$residuals,xlab="sqrt.Age",ylab="Residuals")
abline(0,0,col="red")
```


# BP test

```{r}
BP=lm(y~x,data=data.frame(y=m3$residual^2,x=data2.c[[5]]))
(anova(BP)$Sum[1]/2)/(anova(m3)$Sum[length(anova(m3)$Sum)]/length(data2.c[[5]]))
qchisq(0.95,1)

# const residuals variance
```


# Lack-of-fit test

我們針對 $m_3$ 進行 LOF

```{r}
index=c(38,53,56,47,76,42,89,120,131,161,191,199,219,220,245,195,283,306,317,309,362,355,379,350,440,448,472,460,477)
library(zoo)
Y.m=c(rep(mean(data2.c[index,]$CCS[(1:3)]),3),rep(rollapply(data2.c[index,]$CCS[-(1:3)],2,mean)[-seq(2,24,2)],each=2))

SSPE=sum((Y.m-data2.c[index,]$CCS)^2)
SSPE
SSLF=sum((unique(Y.m)-unique(m3$fitted[index])[-2][-11])^2)
SSLF
SSLF/7/(SSPE/15)
qf(0.99,7,15)     # significance level (alpha) = 0.01
```

## Hypotheses

- $H_0: E(\sqrt{CCS}) = Cement + BFS + FlyAsh + Water + Age + \sqrt{Age}$
- $H_1: E(\sqrt{CCS}) \neq Cement + BFS + FlyAsh + Water + Age + \sqrt{Age}$

## Parameters

- c: 14, 為變數 Cement, BFS, FlyAsh, Water 以及 Age 維持同樣 level, 且 CCS 不同值的組數
- n: 29, 這 14 組總共有 29 筆觀察值, $\sum_{j=1}^{c=14} n_j=n=29$
- p: 7, 共 6 個變數加上 1 個截距項
- $\alpha$: 0.01

將上述變量代進下列公式計算$F^*$

- $F^* = \dfrac{SSLF}{c-p} \div \dfrac{SSPE}{n-c} = \dfrac{MSLF}{MSPE} = 3.83$
- $F_{1-\alpha,c-p,n-c} = 4.14$

由於 $F^* \leq F_{1-\alpha,c-p,n-c}$，故我們接受$H_0$.


# The Bonferroni joint confidence intervals

預測模型 $m_3$ 的係數 $\beta_0, \beta_1, ..., \beta_6$ 的聯合信賴區間。

```{r}
library(knitr)
coef =m3$coefficients
sde = summary(m3)$coef[,2]

B<-qt((1-0.05/(2*7)),508)
p = 7
lower = c()
upper = c()
for (i in 1:p){
  lower[i] = coef[i] - sde[i]*B
  upper[i] = coef[i] + sde[i]*B
}

tb2 <- cbind(lower,upper)
colnames(tb2) <- c("Lower bound","Upper bound")
rownames(tb2) <- c(expression(beta_0,beta_1,beta_2,beta_3,beta_4,beta_5,beta_6))
kable(tb2)
```